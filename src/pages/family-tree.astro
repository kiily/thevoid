---
import Layout from '../layouts/Layout.astro';

// Import family-chart CSS - let library handle styling
import 'family-chart/styles/family-chart.css';
---

<Layout
	title="Family Tree | The void"
	description="Interactive family tree visualization"
>
	<div class="container mx-auto px-6 py-8 max-w-7xl">
		<header class="mb-8">
			<h1
				class="text-4xl font-bold text-garden-primary dark:text-garden-dark-primary mb-4 font-ui"
			>
				Family Tree (Proof of Concept)
			</h1>
			<p
				class="text-xl text-garden-secondary dark:text-garden-dark-secondary font-body"
			>
				Testing family-chart library integration with Astro
			</p>
		</header>

		<div
			id="family-tree-canvas"
			class="f3 family-tree-container rounded-lg shadow-lg"
		>
			<!-- Search and controls rendered inside by script -->
		</div>
	</div>
</Layout>

<script>
	import { familyMembers } from '../features/family-tree/data/family-members';

	document.addEventListener('DOMContentLoaded', async () => {
		try {
			const container = document.getElementById('family-tree-canvas');
			if (!container) return;

			const d3 = await import('d3');
			const { createChart } = await import('family-chart');

			const chart = createChart(container, familyMembers);

			// Configure chart (matching big-tree example)
			chart.setTransitionTime(1000);
			chart.setCardXSpacing(250);
			chart.setCardYSpacing(150);

			// Configure card display with shorter height
			chart
				.setCardHtml()
				.setCardDisplay([['first_name', 'last_name'], ['birthday']])
				.setCardDim({ h: 70 });

			const originalMainId = '1';

			// Initial render
			chart.updateTree({ initial: true });

			// Navigate to a specific person
			function navigateToPerson(personId: string, animate = true) {
				chart.updateMainId(personId);
				chart.updateTree({ initial: animate });
			}

			// Build search options from family data
			const searchOptions = familyMembers.map((member) => ({
				id: member.id,
				label: `${member.data.first_name} ${member.data.last_name}`.trim(),
			}));

			// Create controls container
			const controlsContainer = d3
				.select(container)
				.append('div')
				.attr(
					'style',
					'position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: none;'
				);

			// Search container (left side)
			const searchCont = controlsContainer
				.append('div')
				.attr('style', 'width: 200px; pointer-events: auto;')
				.on('focusout', () => {
					setTimeout(() => {
						if (!searchCont.node()?.contains(document.activeElement)) {
							updateDropdown([]);
						}
					}, 200);
				});

			const searchInput = searchCont
				.append('input')
				.attr(
					'style',
					'width: 100%; padding: 8px 12px; border-radius: 6px; border: none; background: rgba(255,255,255,0.9); color: #333; font-size: 14px;'
				)
				.attr('type', 'text')
				.attr('placeholder', 'Search family members...')
				.on('focus', activateDropdown)
				.on('input', activateDropdown);

			const dropdown = searchCont
				.append('div')
				.attr(
					'style',
					'overflow-y: auto; max-height: 200px; background-color: rgba(0,0,0,0.9); border-radius: 6px; margin-top: 4px;'
				)
				.attr('tabindex', '0')
				.on('wheel', (e: WheelEvent) => {
					e.stopPropagation();
				});

			function activateDropdown() {
				const inputNode = searchInput.node() as HTMLInputElement | null;
				const searchValue = inputNode?.value?.toLowerCase() || '';
				const filtered = searchOptions.filter((opt) =>
					opt.label.toLowerCase().includes(searchValue)
				);
				updateDropdown(filtered);
			}

			function updateDropdown(options: { id: string; label: string }[]) {
				dropdown
					.selectAll('div')
					.data(options)
					.join('div')
					.attr(
						'style',
						'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.2); color: #fff; font-size: 13px;'
					)
					.on('click', (_e: MouseEvent, d: { id: string; label: string }) => {
						navigateToPerson(d.id, true);
						updateDropdown([]);
						const inputNode = searchInput.node() as HTMLInputElement | null;
						if (inputNode) inputNode.value = '';
					})
					.text((d: { id: string; label: string }) => d.label);
			}

			// Buttons container (right side)
			const buttonsCont = controlsContainer
				.append('div')
				.attr('style', 'display: flex; gap: 8px; pointer-events: auto;');

			const buttonStyle =
				'padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; transition: opacity 0.2s;';

			// Reset button
			buttonsCont
				.append('button')
				.text('Reset')
				.attr(
					'style',
					buttonStyle + 'background: rgba(255,255,255,0.9); color: #333;'
				)
				.on('click', () => {
					navigateToPerson(originalMainId, true);
				});

			// Fit View button
			buttonsCont
				.append('button')
				.text('Fit View')
				.attr(
					'style',
					buttonStyle + 'background: rgba(255,255,255,0.9); color: #333;'
				)
				.on('click', () => {
					chart.updateTree({ tree_position: 'fit' });
				});

			// Random button
			buttonsCont
				.append('button')
				.text('Random')
				.attr('style', buttonStyle + 'background: #90ee90; color: #333;')
				.on('click', () => {
					const randomMember =
						familyMembers[Math.floor(Math.random() * familyMembers.length)];
					navigateToPerson(randomMember.id, false);
				});
		} catch (error) {
			console.error('Family chart error:', error);
		}
	});
</script>

<style>
	.family-tree-container {
		position: relative;
		width: 100%;
		height: 80vh;
		min-height: 600px;
		background-color: rgb(33, 33, 33);
		color: #fff;
	}
</style>
