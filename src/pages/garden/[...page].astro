---
import Layout from '../../layouts/Layout.astro';
import Search from '../../components/Search.astro';
import PostCard from '../../components/PostCard.astro';
import Badge from '../../components/Badge.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths, Page } from 'astro';
import type { CollectionEntry } from 'astro:content';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const posts = await getCollection('garden');
  const sortedPosts = posts.sort((a, b) =>
    b.data.publishDate.getTime() - a.data.publishDate.getTime()
  );

  return paginate(sortedPosts, { pageSize: 12 });
}

interface Props {
  page: Page<CollectionEntry<'garden'>>;
}

const { page }: Props = Astro.props;
const allPosts = await getCollection('garden');

// Get unique categories and tags with counts
const categoryCounts = allPosts.reduce((acc, post) => {
  acc[post.data.category] = (acc[post.data.category] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const tagCounts = allPosts.reduce((acc, post) => {
  (post.data.tags || []).forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

// Sort tags by count
const sortedTags = Object.entries(tagCounts)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 12); // Top 12 tags
---

<Layout title={`Digital Garden${page.currentPage > 1 ? ` - Page ${page.currentPage}` : ''} | Miguel Marin`}>
  <div class="container mx-auto max-w-5xl px-6 md:px-8 py-20">
    <header class="mb-10">
      <h1 class="text-garden-primary dark:text-garden-dark-primary mb-3">Garden</h1>
      <p class="text-lg text-body">A space where ideas grow and thoughts interconnect.</p>
    </header>

    <!-- Search and Filters Row -->
    <div class="mb-10 space-y-4">
      <Search
        id="garden-search"
        placeholder="Search posts..."
        showTypes={false}
        contentFilter="garden-only"
      />

      <!-- Compact Filter Bar -->
      <div class="flex flex-wrap items-center gap-3">
        <span class="text-sm text-body font-ui">Filter:</span>

        <!-- Categories as inline links -->
        <div class="flex items-center gap-2">
          {Object.entries(categoryCounts).map(([category, count]) => (
            <a
              href={`/category/${category}`}
              class="text-sm font-medium text-body hover:text-garden-accent dark:hover:text-garden-dark-accent transition-colors font-ui"
            >
              {category} <span class="text-gray-600 dark:text-gray-400">({count})</span>
            </a>
          ))}
        </div>

        <span class="text-gray-300 dark:text-gray-700">|</span>

        <!-- Tags Dropdown -->
        <details class="relative tags-dropdown">
          <summary class="flex items-center gap-1.5 text-sm font-medium text-body hover:text-garden-accent dark:hover:text-garden-dark-accent transition-colors font-ui cursor-pointer list-none">
            <span>Tags</span>
            <svg class="w-4 h-4 transition-transform tags-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </summary>

          <div class="absolute top-full left-0 mt-2 p-4 bg-white dark:bg-garden-dark-surface rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-20 min-w-[280px]">
            <div class="flex flex-wrap gap-2">
              {sortedTags.map(([tag, count]) => (
                <Badge href={`/tag/${tag}`} size="sm">
                  {tag} <span class="opacity-60">({count})</span>
                </Badge>
              ))}
            </div>
            {Object.keys(tagCounts).length > 12 && (
              <a
                href="/tags"
                class="block mt-3 pt-3 border-t border-gray-200 dark:border-gray-700 text-xs text-garden-accent dark:text-garden-dark-accent font-ui underline underline-offset-2"
              >
                View all {Object.keys(tagCounts).length} tags →
              </a>
            )}
          </div>
        </details>
      </div>
    </div>

    <!-- Posts count -->
    <div class="mb-6 text-sm text-gray-600 dark:text-gray-400 font-ui">
      {page.total} posts
      {page.lastPage > 1 && <span>• Page {page.currentPage} of {page.lastPage}</span>}
    </div>

    <!-- Posts Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
      {page.data.map((post: CollectionEntry<'garden'>) => (
        <PostCard
          title={post.data.title}
          description={post.data.description}
          publishDate={post.data.publishDate}
          updateDate={post.data.updateDate}
          url={`/garden/${post.slug}`}
          tags={post.data.tags}
          image={post.data.image}
          variant="card"
        />
      ))}
    </div>

    <!-- Pagination Navigation -->
    {page.lastPage > 1 && (
      <nav class="flex justify-center items-center gap-2" aria-label="Pagination">
        {page.url.prev ? (
          <a
            href={page.url.prev}
            class="px-3 py-2 text-sm text-body hover:text-garden-accent dark:hover:text-garden-dark-accent transition-colors font-ui"
          >
            ← Prev
          </a>
        ) : (
          <span class="px-3 py-2 text-sm text-gray-300 dark:text-gray-700 font-ui">← Prev</span>
        )}

        <div class="flex gap-1">
          {Array.from({ length: page.lastPage }, (_, i) => i + 1).map(pageNum => (
            pageNum === page.currentPage ? (
              <span class="w-8 h-8 flex items-center justify-center text-sm bg-garden-primary dark:bg-garden-dark-primary text-white dark:text-garden-dark-background rounded font-ui">
                {pageNum}
              </span>
            ) : (
              <a
                href={pageNum === 1 ? '/garden' : `/garden/${pageNum}`}
                class="w-8 h-8 flex items-center justify-center text-sm text-body hover:bg-gray-100 dark:hover:bg-gray-800 rounded transition-colors font-ui"
              >
                {pageNum}
              </a>
            )
          ))}
        </div>

        {page.url.next ? (
          <a
            href={page.url.next}
            class="px-3 py-2 text-sm text-body hover:text-garden-accent dark:hover:text-garden-dark-accent transition-colors font-ui"
          >
            Next →
          </a>
        ) : (
          <span class="px-3 py-2 text-sm text-gray-300 dark:text-gray-700 font-ui">Next →</span>
        )}
      </nav>
    )}
  </div>
</Layout>

<style>
  /* Hide default details marker */
  .tags-dropdown summary::-webkit-details-marker {
    display: none;
  }
  .tags-dropdown summary::marker {
    display: none;
    content: '';
  }
  /* Rotate chevron when open */
  .tags-dropdown[open] .tags-chevron {
    transform: rotate(180deg);
  }
</style> 